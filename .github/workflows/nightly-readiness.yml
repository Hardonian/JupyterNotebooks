name: Nightly Readiness Updates

on:
  schedule:
    - cron: '0 3 * * *'  # 3 AM UTC daily
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  nightly-updates:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install bandit safety jq
    
    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Create update branch
      run: |
        BRANCH_NAME="automated/nightly-readiness-updates-$(date +%Y%m%d)"
        git checkout -b "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
    
    - name: Run Security Audit
      continue-on-error: true
      run: |
        echo "Running security audit..."
        SKIP_INTERACTIVE=true bash scripts/security-audit.sh || true
      env:
        SKIP_INTERACTIVE: true
    
    - name: Run Test Coverage Analysis
      continue-on-error: true
      run: |
        echo "Analyzing test coverage..."
        SKIP_INTERACTIVE=true bash scripts/test-coverage-improvement.sh || true
      env:
        SKIP_INTERACTIVE: true
    
    - name: Analyze Data Room Placeholders
      continue-on-error: true
      run: |
        echo "Analyzing data room placeholders..."
        SKIP_INTERACTIVE=true python3 scripts/fill-dataroom-placeholders.py || true
      env:
        SKIP_INTERACTIVE: true
    
    - name: Generate Metrics Snapshot Template
      continue-on-error: true
      run: |
        echo "Generating metrics snapshot template..."
        SKIP_INTERACTIVE=true PRODUCTION_URL="${PRODUCTION_URL:-http://localhost:8000}" bash scripts/collect-metrics.sh || true
      env:
        SKIP_INTERACTIVE: true
        PRODUCTION_URL: ${{ secrets.PRODUCTION_URL || 'http://localhost:8000' }}
    
    - name: Generate Unit Economics Template
      continue-on-error: true
      run: |
        echo "Generating unit economics template..."
        SKIP_INTERACTIVE=true python3 scripts/calculate-unit-economics.py || true
      env:
        SKIP_INTERACTIVE: true
    
    - name: Update Weekly Progress
      continue-on-error: true
      run: |
        echo "Updating weekly progress..."
        SKIP_INTERACTIVE=true bash scripts/weekly-progress.sh || true
      env:
        SKIP_INTERACTIVE: true
    
    - name: Run Readiness Check
      continue-on-error: true
      run: |
        echo "Running comprehensive readiness check..."
        SKIP_INTERACTIVE=true bash scripts/quick-start-readiness.sh > readiness-report.txt || true
      env:
        SKIP_INTERACTIVE: true
    
    - name: Check for changes
      id: changes
      run: |
        git add -A
        if git diff --staged --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Changes detected:"
          git diff --staged --name-only
        fi
    
    - name: Commit changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        git add -A
        git commit -m "ðŸ¤– Nightly: Automated readiness updates

        - Security audit reports updated
        - Test coverage plan updated
        - Data room placeholder analysis
        - Metrics snapshot template updated
        - Unit economics template updated
        - Weekly progress updated
        - Readiness check completed

        Generated by Nightly Readiness workflow on $(date +%Y-%m-%d)"
        git push origin HEAD || true
    
    - name: Create Pull Request
      if: steps.changes.outputs.changed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const branchName = `automated/nightly-readiness-updates-${new Date().toISOString().split('T')[0].replace(/-/g, '')}`;
          
          const pr = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸ¤– Automated: Nightly Readiness Updates - ${new Date().toISOString().split('T')[0]}`,
            head: branchName,
            base: 'main',
            body: `## ðŸ¤– Automated Nightly Readiness Updates

          This PR contains automatically generated updates from the nightly readiness workflow.

          **Generated Files:**
          - Security audit reports (if updated)
          - Test coverage improvement plan (if updated)
          - Data room placeholder analysis (if updated)
          - Metrics snapshot template (if updated)
          - Unit economics template (if updated)
          - Weekly progress (if updated)
          - Readiness check report (if updated)

          **Review Checklist:**
          - [ ] Review security audit findings
          - [ ] Review test coverage improvements
          - [ ] Fill in data room placeholders with real data
          - [ ] Update metrics with actual numbers
          - [ ] Review and merge if changes are valid

          ---
          *This PR was automatically created by the Nightly Readiness workflow*`
          });
          
          console.log(`Created PR #${pr.data.number}`);
