name: Database Migrations

on:
  push:
    branches: [main]
    paths:
      - 'alembic/versions/**'
      - 'agent_factory/database/models.py'
      - '.github/workflows/db-migrate.yml'
  workflow_dispatch:
    inputs:
      revision:
        description: 'Migration revision (default: head)'
        required: false
        default: 'head'
      dry_run:
        description: 'Dry run (validate only, do not apply)'
        required: false
        default: 'false'

jobs:
  validate-migrations:
    name: Validate Migration Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install alembic psycopg2-binary
      
      - name: Validate migration files
        run: |
          echo "Validating migration files..."
          python -c "
          import os
          import sys
          from pathlib import Path
          
          # Check all migration files are valid Python
          migrations_dir = Path('alembic/versions')
          errors = []
          
          for migration_file in migrations_dir.glob('*.py'):
              if migration_file.name == '__init__.py':
                  continue
              try:
                  compile(open(migration_file).read(), migration_file, 'exec')
              except SyntaxError as e:
                  errors.append(f'{migration_file}: {e}')
          
          if errors:
              print('Migration validation errors:')
              for error in errors:
                  print(f'  {error}')
              sys.exit(1)
          
          print('✓ All migration files are valid Python')
          "
      
      - name: Check migration chain
        run: |
          echo "Checking migration chain..."
          alembic history | head -20 || echo "No migrations found (this is OK for new projects)"
  
  apply-migrations:
    name: Apply Migrations
    runs-on: ubuntu-latest
    needs: validate-migrations
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'false')
    environment:
      name: production
      url: ${{ secrets.DATABASE_URL != '' && 'Database migrations applied' || 'No database configured' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install alembic psycopg2-binary
      
      - name: Check database connection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "⚠️  DATABASE_URL secret not set. Skipping migration."
            echo "To enable migrations, set DATABASE_URL in repository secrets."
            exit 0
          fi
          
          echo "Testing database connection..."
          python -c "
          import os
          from sqlalchemy import create_engine, text
          
          db_url = os.getenv('DATABASE_URL')
          if not db_url:
              print('DATABASE_URL not set')
              exit(1)
          
          try:
              engine = create_engine(db_url, connect_args={'connect_timeout': 10})
              with engine.connect() as conn:
                  result = conn.execute(text('SELECT version()'))
                  version = result.scalar()
                  print(f'✓ Connected to: {version[:50]}...')
          except Exception as e:
              print(f'✗ Connection failed: {e}')
              exit(1)
          "
      
      - name: Show current revision
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            exit 0
          fi
          echo "Current database revision:"
          alembic current || echo "No migrations applied yet"
      
      - name: Show migration plan
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            exit 0
          fi
          echo "Migration plan:"
          REVISION="${{ github.event.inputs.revision || 'head' }}"
          alembic upgrade --sql "$REVISION" | head -50 || echo "No migrations to apply"
      
      - name: Apply migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "⚠️  Skipping migration (DATABASE_URL not set)"
            exit 0
          fi
          
          REVISION="${{ github.event.inputs.revision || 'head' }}"
          
          echo "Applying migrations to revision: $REVISION"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          
          if alembic upgrade "$REVISION"; then
            echo "✓ Migrations applied successfully"
            echo ""
            echo "New revision:"
            alembic current
          else
            echo "✗ Migration failed!"
            exit 1
          fi
      
      - name: Validate schema
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            exit 0
          fi
          
          echo "Validating database schema..."
          python scripts/db-validate-schema.py || echo "⚠️  Schema validation script not found (this is OK)"
  
  dry-run-migrations:
    name: Dry Run Migrations
    runs-on: ubuntu-latest
    needs: validate-migrations
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install alembic psycopg2-binary
      
      - name: Dry run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          REVISION="${{ github.event.inputs.revision || 'head' }}"
          
          echo "Dry run: Migration plan for revision: $REVISION"
          echo ""
          
          if [ -z "$DATABASE_URL" ]; then
            echo "⚠️  DATABASE_URL not set. Showing SQL without executing..."
            alembic upgrade --sql "$REVISION" || echo "No migrations to apply"
          else
            echo "Showing SQL that would be executed:"
            alembic upgrade --sql "$REVISION" || echo "No migrations to apply"
          fi
