name: Multi-Environment Deployment

on:
  push:
    branches:
      - develop  # Deploy to staging
      - main     # Deploy to production
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should_deploy: ${{ steps.env.outputs.should_deploy }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            ENV="staging"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="unknown"
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "Deploying to: $ENV"

  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: determine-environment
    if: needs.determine-environment.outputs.should_deploy == 'true' && github.event.inputs.skip_tests != 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run tests
        run: |
          pytest tests/ -v --cov=agent_factory --cov-report=xml
      
      - name: Run linting
        run: |
          ruff check agent_factory/ tests/
          black --check agent_factory/ tests/
          mypy agent_factory/

  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [determine-environment, run-tests]
    if: needs.determine-environment.outputs.should_deploy == 'true'
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install alembic psycopg2-binary
      
      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets[format('{0}_DATABASE_URL', needs.determine-environment.outputs.environment)] }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "⚠️  Database URL not configured for ${{ needs.determine-environment.outputs.environment }}"
            exit 0
          fi
          
          echo "Running migrations for ${{ needs.determine-environment.outputs.environment }}..."
          alembic upgrade head
          
          echo "Validating schema..."
          python scripts/db-validate-schema.py || echo "⚠️  Schema validation had issues"

  deploy:
    name: Deploy to ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [determine-environment, run-tests, run-migrations]
    if: needs.determine-environment.outputs.should_deploy == 'true'
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
      url: ${{ secrets[format('{0}_API_URL', needs.determine-environment.outputs.environment)] }}
    strategy:
      matrix:
        target: [render, docker]
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Render (${{ needs.determine-environment.outputs.environment }})
        if: matrix.target == 'render'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets[format('RENDER_{0}_SERVICE_ID', needs.determine-environment.outputs.environment)] }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "⚠️  Render not configured for ${{ needs.determine-environment.outputs.environment }}"
            exit 0
          fi
          
          echo "Deploying to Render (${{ needs.determine-environment.outputs.environment }})..."
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": true}'
          
          echo "✓ Render deployment triggered"
      
      - name: Build Docker image (${{ needs.determine-environment.outputs.environment }})
        if: matrix.target == 'docker'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}:${{ needs.determine-environment.outputs.environment }}-latest
            ${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}:${{ needs.determine-environment.outputs.environment }}-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  smoke-tests:
    name: Smoke Tests (${{ needs.determine-environment.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy]
    if: needs.determine-environment.outputs.should_deploy == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Run smoke tests
        env:
          API_BASE_URL: ${{ secrets[format('{0}_API_URL', needs.determine-environment.outputs.environment)] }}
        run: |
          if [ -z "$API_BASE_URL" ]; then
            echo "⚠️  API URL not configured for ${{ needs.determine-environment.outputs.environment }}"
            exit 0
          fi
          
          chmod +x scripts/smoke-tests.sh
          ./scripts/smoke-tests.sh || {
            echo "⚠️  Smoke tests failed for ${{ needs.determine-environment.outputs.environment }}"
            exit 0
          }

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy, smoke-tests]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"
          echo "## Deployment to $ENV" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: $ENV" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Smoke Tests: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "API URL: ${{ secrets[format('{0}_API_URL', needs.determine-environment.outputs.environment)] || 'Not configured' }}" >> $GITHUB_STEP_SUMMARY
