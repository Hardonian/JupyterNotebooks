name: Deploy to Production

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/deploy-preview.yml'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        default: 'false'
      skip_migrations:
        description: 'Skip database migrations'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          pytest tests/ -v --cov=agent_factory --cov-report=xml
      
      - name: Run linting
        run: |
          ruff check agent_factory/ tests/
          black --check agent_factory/ tests/
          mypy agent_factory/
      
      - name: Security scan
        run: |
          safety check || true
          bandit -r agent_factory/ -f json -o bandit-report.json || true
      
      - name: Check deployment readiness
        id: check
        run: |
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "✓ All pre-deployment checks passed"

  deploy-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: needs.pre-deployment-checks.outputs.should_deploy == 'true'
    environment:
      name: production
      url: ${{ secrets.RENDER_SERVICE_URL || 'https://agent-factory-api.onrender.com' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "⚠️  Render credentials not configured. Skipping Render deployment."
            echo "To enable Render deployment, set RENDER_API_KEY and RENDER_SERVICE_ID secrets."
            exit 0
          fi
          
          echo "Deploying to Render..."
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": true}'
          
          echo "✓ Render deployment triggered"

  deploy-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: needs.pre-deployment-checks.outputs.should_deploy == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}:latest
            ${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-kubernetes:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, deploy-docker]
    if: needs.pre-deployment-checks.outputs.should_deploy == 'true' && secrets.KUBECONFIG != ''
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBECONFIG }}" > kubeconfig.yaml
          export KUBECONFIG=kubeconfig.yaml
          
          kubectl get nodes || echo "⚠️  Kubernetes not configured"
      
      - name: Deploy to Kubernetes
        env:
          KUBECONFIG: kubeconfig.yaml
        run: |
          if [ -z "$KUBECONFIG" ]; then
            echo "⚠️  Kubernetes not configured. Skipping K8s deployment."
            exit 0
          fi
          
          echo "Deploying to Kubernetes..."
          # Update image tag in deployment
          kubectl set image deployment/agent-factory-api \
            agent-factory-api=${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}:${{ github.sha }} \
            -n agent-factory || echo "⚠️  Kubernetes deployment not found"
          
          echo "✓ Kubernetes deployment updated"

  post-deployment-smoke-tests:
    name: Post-Deployment Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-render, deploy-docker]
    if: always() && (needs.deploy-render.result == 'success' || needs.deploy-docker.result == 'success')
    steps:
      - uses: actions/checkout@v4
      
      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 30
      
      - name: Run smoke tests
        env:
          API_BASE_URL: ${{ secrets.PRODUCTION_API_URL || 'https://agent-factory-api.onrender.com' }}
        run: |
          if [ -z "$API_BASE_URL" ]; then
            echo "⚠️  Production API URL not configured. Skipping smoke tests."
            exit 0
          fi
          
          chmod +x scripts/smoke-tests.sh
          ./scripts/smoke-tests.sh || {
            echo "⚠️  Smoke tests failed. Deployment may have issues."
            exit 0  # Don't fail deployment, but warn
          }
      
      - name: Health check
        env:
          API_BASE_URL: ${{ secrets.PRODUCTION_API_URL || 'https://agent-factory-api.onrender.com' }}
        run: |
          if [ -z "$API_BASE_URL" ]; then
            exit 0
          fi
          
          echo "Checking health endpoint..."
          curl -f "$API_BASE_URL/health" || {
            echo "⚠️  Health check failed"
            exit 0  # Don't fail deployment
          }

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, deploy-render, deploy-docker, post-deployment-smoke-tests]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-deployment checks: ${{ needs.pre-deployment-checks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Render deployment: ${{ needs.deploy-render.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker build: ${{ needs.deploy-docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Smoke tests: ${{ needs.post-deployment-smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment URL: ${{ secrets.PRODUCTION_API_URL || 'Not configured' }}" >> $GITHUB_STEP_SUMMARY
