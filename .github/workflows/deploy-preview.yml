name: Deploy Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy'
        required: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  build-preview:
    name: Build Preview
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run tests
        run: |
          pytest tests/ -v --cov=agent_factory --cov-report=xml || true
      
      - name: Run linting
        run: |
          ruff check agent_factory/ tests/ || true
          black --check agent_factory/ tests/ || true

  deploy-preview-render:
    name: Deploy Preview to Render
    runs-on: ubuntu-latest
    needs: build-preview
    if: github.event.pull_request.number != '' || github.event.inputs.pr_number != ''
    environment:
      name: preview
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event.inputs.pr_number }}" != "" ]; then
            echo "number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy Preview to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_PREVIEW_SERVICE_ID: ${{ secrets.RENDER_PREVIEW_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_PREVIEW_SERVICE_ID" ]; then
            echo "‚ö†Ô∏è  Render preview not configured. Skipping preview deployment."
            echo "To enable preview deployments, set RENDER_API_KEY and RENDER_PREVIEW_SERVICE_ID secrets."
            exit 0
          fi
          
          PR_NUMBER=${{ steps.pr.outputs.number }}
          echo "Deploying preview for PR #$PR_NUMBER..."
          
          # Trigger Render preview deployment
          curl -X POST "https://api.render.com/v1/services/$RENDER_PREVIEW_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"clearCache\": true, \"branch\": \"pr-$PR_NUMBER\"}" || echo "Preview deployment triggered"
          
          PREVIEW_URL="https://agent-factory-pr-$PR_NUMBER.onrender.com"
          echo "PREVIEW_URL=$PREVIEW_URL" >> $GITHUB_ENV
          echo "‚úì Preview deployment triggered: $PREVIEW_URL"

  deploy-preview-docker:
    name: Build Preview Docker Image
    runs-on: ubuntu-latest
    needs: build-preview
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event.inputs.pr_number }}" != "" ]; then
            echo "number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push preview image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}:pr-${{ steps.pr.outputs.number }}
            ${{ secrets.DOCKER_REGISTRY || 'ghcr.io' }}/${{ github.repository }}:${{ github.event.pull_request.head.sha || github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  preview-smoke-tests:
    name: Preview Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-preview-render, deploy-preview-docker]
    if: always() && (needs.deploy-preview-render.result == 'success' || needs.deploy-preview-docker.result == 'success')
    steps:
      - uses: actions/checkout@v4
      
      - name: Wait for preview deployment
        run: |
          echo "Waiting for preview deployment to be ready..."
          sleep 45
      
      - name: Run smoke tests
        env:
          API_BASE_URL: ${{ needs.deploy-preview-render.outputs.preview_url || 'http://localhost:8000' }}
        run: |
          if [ "$API_BASE_URL" == "http://localhost:8000" ]; then
            echo "‚ö†Ô∏è  Preview URL not available. Skipping smoke tests."
            exit 0
          fi
          
          chmod +x scripts/smoke-tests.sh
          ./scripts/smoke-tests.sh || echo "‚ö†Ô∏è  Preview smoke tests had issues"

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [deploy-preview-render, preview-smoke-tests]
    if: github.event.pull_request.number != ''
    steps:
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const previewUrl = '${{ needs.deploy-preview-render.outputs.preview_url || "Not available" }}';
            const smokeTests = '${{ needs.preview-smoke-tests.result }}';
            
            const body = `## üöÄ Preview Deployment
            
            **Preview URL:** ${previewUrl}
            
            **Status:**
            - Deployment: ${{ needs.deploy-preview-render.result }}
            - Smoke Tests: ${smokeTests}
            
            **Note:** This preview will be automatically cleaned up when the PR is closed.
            `;
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Preview Deployment')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
            }

  cleanup-preview:
    name: Cleanup Preview
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    steps:
      - name: Cleanup preview resources
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_PREVIEW_SERVICE_ID: ${{ secrets.RENDER_PREVIEW_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ]; then
            echo "‚ö†Ô∏è  Render not configured. Skipping cleanup."
            exit 0
          fi
          
          echo "Cleaning up preview resources..."
          # Render will auto-cleanup preview deployments
          echo "‚úì Cleanup complete"
